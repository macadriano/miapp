{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Flota - WayGPS</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    
    <style>
        .map-container {
            height: calc(100vh - 200px);
            min-height: 600px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .map-controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .stats-card h6 {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .stats-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .custom-marker-with-label {
            background: transparent;
            border: none;
        }
    </style>
</head>
<body data-page="mapa">
    <div class="app-wrapper" id="appWrapper">
        {% include 'partials/sidebar.html' %}
        <div class="main-area">
            <div class="topbar">
                <div class="d-flex align-items-center gap-3">
                    <button class="sidebar-toggle" id="sidebarToggle" type="button" title="Mostrar/ocultar men√∫">
                        <i class="bi bi-list"></i>
                    </button>
                    <h1 class="topbar-title mb-0">
                        <i class="bi bi-map me-2"></i> Mapa de Flota
                    </h1>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-primary btn-sm" onclick="refreshMapa()">
                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                    </button>
                    <a class="btn btn-light btn-sm" href="/moviles/dashboard/">
                        <i class="bi bi-house me-1"></i> Home
                    </a>
                </div>
            </div>
            <div class="app-content">
                <!-- Estad√≠sticas r√°pidas -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h6><i class="bi bi-truck"></i> Total M√≥viles</h6>
                            <div class="stat-value" id="total-moviles">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                            <h6><i class="bi bi-check-circle"></i> En L√≠nea</h6>
                            <div class="stat-value" id="moviles-online">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                            <h6><i class="bi bi-x-circle"></i> Desconectados</h6>
                            <div class="stat-value" id="moviles-offline">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                            <h6><i class="bi bi-lightning-charge"></i> Con Ignici√≥n</h6>
                            <div class="stat-value" id="moviles-ignicion">0</div>
                        </div>
                    </div>
                </div>

                <!-- Controles del mapa -->
                <div class="map-controls">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleRecorridos" checked>
                                <label class="form-check-label" for="toggleRecorridos">
                                    Mostrar recorridos
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary btn-sm" onclick="centrarTodos()">
                                <i class="bi bi-geo-alt"></i> Centrar todos los m√≥viles
                            </button>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">
                                √öltima actualizaci√≥n: <span id="ultima-actualizacion">--</span>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Mapa -->
                <div class="card">
                    <div class="card-body p-0">
                        <div id="mapa-flota" class="map-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Configuraci√≥n -->
    <script src="{% static 'js/config.js' %}"></script>
    <!-- Auth -->
    <script src="{% static 'js/auth.js' %}"></script>
    <!-- API Client -->
    <script src="{% static 'js/api-client.js' %}"></script>
    
    <script>
        let mapaFlota = null;
        let markers = [];
        let movilesData = [];
        let baseLayers = {};
        let autoRefreshInterval = null;

        // Inicializar mapa
        function initializeMapa() {
            const mapConfig = WAYGPS_CONFIG.MAP;
            mapaFlota = L.map('mapa-flota').setView([mapConfig.DEFAULT_LAT, mapConfig.DEFAULT_LON], mapConfig.DEFAULT_ZOOM);
            
            // Capa de calles (OpenStreetMap)
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            });
            
            // Capa satelital (Esri World Imagery)
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri',
                maxZoom: 19
            });
            
            // Capa h√≠brida (sat√©lite + etiquetas)
            const hybridLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri',
                maxZoom: 19
            });
            
            const labelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
                attribution: '¬© CartoDB',
                maxZoom: 19
            });
            
            // Agregar capa por defecto
            streetLayer.addTo(mapaFlota);
            
            // Control de capas
            baseLayers = {
                "üó∫Ô∏è Calles": streetLayer,
                "üõ∞Ô∏è Sat√©lite": satelliteLayer,
                "üåç H√≠brido": L.layerGroup([hybridLayer, labelsLayer])
            };
            
            L.control.layers(baseLayers).addTo(mapaFlota);
        }

        // Verificar si un m√≥vil est√° en l√≠nea
        function isOnline(movil) {
            if (!movil.fecha_recepcion) return false;
            const ultimaRecepcion = new Date(movil.fecha_recepcion);
            const ahora = new Date();
            const diferenciaMinutos = (ahora - ultimaRecepcion) / (1000 * 60);
            return diferenciaMinutos <= WAYGPS_CONFIG.STATUS.ONLINE_THRESHOLD_MINUTES;
        }

        // Crear popup para m√≥vil
        function createMovilPopup(movil) {
            const status = movil.status_info || {};
            const online = isOnline(movil);
            const onlineText = online ? '<span class="badge bg-success">En l√≠nea</span>' : '<span class="badge bg-danger">Desconectado</span>';
            
            return `
                <div style="min-width: 200px;">
                    <h6 style="margin-bottom: 10px;">${movil.patente || movil.alias || 'N/A'}</h6>
                    <div style="margin-bottom: 5px;">${onlineText}</div>
                    ${status.ultima_velocidad_kmh ? `<div><strong>Velocidad:</strong> ${status.ultima_velocidad_kmh} km/h</div>` : ''}
                    ${status.ultimo_rumbo ? `<div><strong>Rumbo:</strong> ${status.ultimo_rumbo}¬∞</div>` : ''}
                    ${status.fecha_gps ? `<div><strong>√öltima posici√≥n:</strong><br><small>${new Date(status.fecha_gps).toLocaleString('es-AR')}</small></div>` : ''}
                    <div style="margin-top: 10px;">
                        <a href="/moviles/?movil_id=${movil.id}" class="btn btn-sm btn-primary" target="_blank">
                            Ver detalles
                        </a>
                    </div>
                </div>
            `;
        }

        // Actualizar mapa con m√≥viles
        function updateMapa() {
            if (!mapaFlota) return;
            
            // Limpiar marcadores existentes
            markers.forEach(marker => mapaFlota.removeLayer(marker));
            markers = [];
            
            let totalOnline = 0;
            let totalOffline = 0;
            let totalIgnicion = 0;
            
            // Agregar marcadores para cada m√≥vil
            movilesData.forEach(movil => {
                const status = movil.status_info || {};
                if (status.ultimo_lat && status.ultimo_lon) {
                    const online = isOnline(movil);
                    if (online) totalOnline++;
                    else totalOffline++;
                    
                    if (status.ignicion) totalIgnicion++;
                    
                    const iconColor = online ? WAYGPS_CONFIG.STATUS.ONLINE_COLOR : WAYGPS_CONFIG.STATUS.OFFLINE_COLOR;
                    
                    // Convertir coordenadas a n√∫meros
                    const lat = parseFloat(status.ultimo_lat);
                    const lon = parseFloat(status.ultimo_lon);
                    
                    // Identificaci√≥n del m√≥vil
                    const label = movil.patente || movil.alias || movil.codigo || 'N/A';
                    
                    // Crear √≠cono personalizado con etiqueta
                    const icon = L.divIcon({
                        className: 'custom-marker-with-label',
                        html: `
                            <div style="text-align: center;">
                                <div style="background-color: ${iconColor}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); margin: 0 auto;"></div>
                                <div style="
                                    background-color: rgba(255,255,255,0.95);
                                    color: #333;
                                    padding: 2px 6px;
                                    border-radius: 3px;
                                    font-size: 11px;
                                    font-weight: bold;
                                    white-space: nowrap;
                                    margin-top: 2px;
                                    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                                    border: 1px solid ${iconColor};
                                ">${label}</div>
                            </div>
                        `,
                        iconSize: [80, 45],
                        iconAnchor: [40, 45]
                    });
                    
                    const marker = L.marker([lat, lon], { icon })
                        .addTo(mapaFlota)
                        .bindPopup(createMovilPopup(movil));
                    
                    markers.push(marker);
                }
            });
            
            // Actualizar estad√≠sticas
            document.getElementById('total-moviles').textContent = movilesData.length;
            document.getElementById('moviles-online').textContent = totalOnline;
            document.getElementById('moviles-offline').textContent = totalOffline;
            document.getElementById('moviles-ignicion').textContent = totalIgnicion;
            
            // Actualizar hora
            document.getElementById('ultima-actualizacion').textContent = new Date().toLocaleTimeString('es-AR');
            
            // Ajustar vista para mostrar todos los marcadores si hay
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                mapaFlota.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Cargar m√≥viles desde la API
        async function cargarMoviles() {
            try {
                const response = await fetch('/moviles/api/moviles/');
                if (!response.ok) throw new Error('Error al cargar m√≥viles');
                
                const data = await response.json();
                movilesData = data.results || data;
                
                updateMapa();
            } catch (error) {
                console.error('Error cargando m√≥viles:', error);
            }
        }

        // Refrescar mapa
        function refreshMapa() {
            cargarMoviles();
        }

        // Centrar todos los m√≥viles
        function centrarTodos() {
            if (!mapaFlota || markers.length === 0) return;
            const group = new L.featureGroup(markers);
            mapaFlota.fitBounds(group.getBounds().pad(0.1));
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar sidebar toggle
            const wrapper = document.getElementById('appWrapper');
            const toggle = document.getElementById('sidebarToggle');
            const storedState = localStorage.getItem('sidebarCollapsed');

            if (storedState === 'true') {
                wrapper.classList.add('collapsed');
            }

            if (toggle) {
                toggle.addEventListener('click', function () {
                    wrapper.classList.toggle('collapsed');
                    localStorage.setItem('sidebarCollapsed', wrapper.classList.contains('collapsed') ? 'true' : 'false');
                });
            }

            const currentPage = document.body.dataset.page;
            const activeLink = document.querySelector(`.sidebar-nav a[data-page="${currentPage}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // Inicializar mapa
            initializeMapa();
            
            // Cargar m√≥viles inicialmente
            cargarMoviles();
            
            // Configurar actualizaci√≥n autom√°tica
            autoRefreshInterval = setInterval(cargarMoviles, WAYGPS_CONFIG.AUTO_REFRESH_INTERVAL);
        });

        // Limpiar intervalo al salir
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>

